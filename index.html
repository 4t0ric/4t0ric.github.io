<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snake Game</title>
  <style>
    :root {
      --bg-dark: #000;
      --bg-light: #f4f4f4;
      --text-dark: #fff;
      --text-light: #111;
      --btn-bg-dark: #222;
      --btn-bg-light: #ddd;
      --btn-text-dark: #eee;
      --btn-text-light: #111;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-dark);
      overflow: hidden;
      transition: background-color 0.4s, color 0.4s;
    }
    #score { position: fixed; top: 10px; left: 10px; font-size: 24px; z-index: 10; user-select: none; }
    #highscore { position: fixed; top: 40px; left: 10px; font-size: 20px; z-index: 10; user-select: none; }
    #powerup-bar {
      position: fixed; top: 70px; left: 10px; right: 10px; height: 12px;
      background: rgba(255,255,255,0.2); border-radius: 6px; overflow: hidden;
      display: flex; gap: 4px; z-index: 10;
    }
    .powerup-segment { height: 100%; transition: width 0.2s linear; border-radius: 4px; }
    #game-over {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: red; font-size: 36px; text-align: center; display: none;
      z-index: 100; user-select: none; cursor: pointer;
    }
    #settings-btn, #achievements-btn {
      position: fixed; top: 10px; z-index: 10;
      padding: 8px 16px; font-size: 20px;
      border: none; border-radius: 8px; cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
    }
    #settings-btn { right: 10px; background-color: var(--btn-bg-dark); color: var(--btn-text-dark); }
    #achievements-btn { right: 140px; background-color: var(--btn-bg-dark); color: var(--btn-text-dark); }
    #settings-btn:hover, #achievements-btn:hover { background-color: var(--btn-text-dark); color: var(--btn-bg-dark); }
    .light-theme #settings-btn, .light-theme #achievements-btn {
      background-color: var(--btn-bg-light); color: var(--btn-text-light);
    }
    .light-theme #settings-btn:hover, .light-theme #achievements-btn:hover {
      background-color: var(--btn-text-light); color: var(--btn-bg-light);
    }
    #settings-modal, #achievements-modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
      padding: 20px; border-radius: 12px; box-shadow: 0 0 10px #000;
      z-index: 1000; display: none; opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease;
      min-width: 260px; user-select: none;
    }
    #settings-modal { background-color: rgba(0,0,0,0.9); color: var(--text-dark); }
    #achievements-modal { background-color: rgba(0,0,0,0.9); color: var(--text-dark); }
    #settings-modal.show { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .setting-group { margin-bottom: 18px; }
    .setting-group label { display: block; margin-bottom: 6px; font-weight: bold; }
    .setting-group button, .setting-group textarea {
      width: 100%; padding: 8px; margin-top: 4px; font-size: 14px;
      border: none; border-radius: 6px; cursor: pointer;
      background-color: var(--btn-bg-dark); color: var(--btn-text-dark);
      transition: background-color 0.3s, color 0.3s;
    }
    .setting-group button:hover { background-color: var(--btn-text-dark); color: var(--btn-bg-dark); }
    .setting-group textarea { resize: none; height: 60px; font-family: monospace; }
    .light-theme #settings-modal, .light-theme #achievements-modal { background-color: #fff; color: var(--text-light); box-shadow: 0 0 12px #aaa; }
    .light-theme .setting-group button { background-color: var(--btn-bg-light); color: var(--btn-text-light); }
    .light-theme .setting-group button:hover { background-color: var(--btn-text-light); color: var(--btn-bg-light); }
    canvas { display: block; }
  </style>
</head>
<body>
  <div id="score">Score: 0</div>
  <div id="highscore">Highscore: 0</div>
  <div id="powerup-bar"></div>
  <div id="game-over">
    Game Over!<br>
    Tap or press R to Restart<br>
    Control the snake with WASD or swipe on mobile!
  </div>
  <button id="settings-btn">‚öôÔ∏è</button>
  <button id="achievements-btn">üèÜ</button>

  <!-- Settings Modal -->
  <!-- ... unchanged ... -->

  <!-- Achievements Modal -->
  <!-- ... unchanged ... -->

  <canvas id="game"></canvas>

  <script>
    (() => {
      const CELL_SIZE = 20;
      let canvas = document.getElementById("game");
      let ctx = canvas.getContext("2d");
      let width, height, columns, rows;
      let snake = [], direction = "Right", nextDirection = "Right";
      let food = null, powerup = null;
      let snakeColor = "green", score = 0, gameOver = false, showGrid = false, darkTheme = true;
      let updateDelay = 100, lastUpdateTime = 0, gamePaused = false;

      const powerupBar = document.getElementById("powerup-bar");
      let activePowerups = [];

      // Powerup types
      const POWERUPS = {
        invincible: { color: "gold", duration: 10000, chance: 0.02 },
        scorex5: { color: "blue", duration: 10000, chance: 0.05 },
        slow: { color: "purple", duration: 15000, chance: 0.05 }
      };

      // Account, achievements... (unchanged)

      function resize(){ width=window.innerWidth; height=window.innerHeight; canvas.width=width; canvas.height=height; columns=Math.floor(width/CELL_SIZE); rows=Math.floor(height/CELL_SIZE); }

      function resetGame(){ activePowerups=[]; powerup=null; gameOver=false; score=0; direction=nextDirection="Right"; const startX=Math.floor(columns/2), startY=Math.floor(rows/2); snake=[{x:startX,y:startY},{x:startX-1,y:startY},{x:startX-2,y:startY}]; placeFood(); scoreDiv.textContent="Score:"+score; gameOverDiv.style.display="none"; updatePowerupBar(); }

      function placeFood(){ while(true){let x=Math.floor(Math.random()*columns),y=Math.floor(Math.random()*rows); if(!snake.some(seg=>seg.x===x && seg.y===y)){ let roll=Math.random(); let type=null; let acc=0; for(let key in POWERUPS){ acc+=POWERUPS[key].chance; if(roll<acc){ type=key; break; } } if(type){ powerup={x,y,type}; food=null; } else { food={x,y}; powerup=null; } break; }} }

      function activatePowerup(type){ let cfg=POWERUPS[type]; activePowerups.push({type, end:Date.now()+cfg.duration}); updatePowerupBar(); }

      function updatePowerupBar(){ powerupBar.innerHTML=""; let now=Date.now(); activePowerups.forEach(pu=>{ let cfg=POWERUPS[pu.type]; let remaining=Math.max(0, pu.end-now); let pct=remaining/cfg.duration*100; let seg=document.createElement("div"); seg.className="powerup-segment"; seg.style.background=cfg.color; seg.style.width=pct+"%"; powerupBar.appendChild(seg); }); }

      function drawCell(x,y,color){ ctx.fillStyle=color; ctx.fillRect(x*CELL_SIZE,y*CELL_SIZE,CELL_SIZE,CELL_SIZE); ctx.strokeStyle=darkTheme?"#222":"#ccc"; ctx.strokeRect(x*CELL_SIZE,y*CELL_SIZE,CELL_SIZE,CELL_SIZE); }
      function draw(){ ctx.clearRect(0,0,width,height); if(showGrid){ for(let x=0;x<=columns;x++){ ctx.beginPath(); ctx.moveTo(x*CELL_SIZE,0); ctx.lineTo(x*CELL_SIZE,rows*CELL_SIZE); ctx.stroke(); } for(let y=0;y<=rows;y++){ ctx.beginPath(); ctx.moveTo(0,y*CELL_SIZE); ctx.lineTo(columns*CELL_SIZE,y*CELL_SIZE); ctx.stroke(); } } if(food) drawCell(food.x,food.y,"red"); if(powerup) drawCell(powerup.x,powerup.y,POWERUPS[powerup.type].color); snake.forEach((seg,i)=>drawCell(seg.x,seg.y,i===0?"lime":snakeColor)); }

      function endGame(){ gameOver=true; gameOverDiv.style.display="block"; }

      function update(timestamp){
        if(!lastUpdateTime) lastUpdateTime=timestamp;
        if(timestamp-lastUpdateTime<updateDelay){ requestAnimationFrame(update); return; }
        lastUpdateTime=timestamp;
        if(gameOver||gamePaused){ requestAnimationFrame(update); return; }

        // expire powerups
        let now=Date.now();
        activePowerups=activePowerups.filter(pu=>pu.end>now);
        updatePowerupBar();

        // check modifiers
        let invincible=activePowerups.some(pu=>pu.type==="invincible");
        let scorex5=activePowerups.some(pu=>pu.type==="scorex5");
        let slow=activePowerups.some(pu=>pu.type==="slow");
        let speedMod=slow?1.5:1; // slower snake
        updateDelay = slow?150:100; // adjust speed

        const opposites={Up:"Down",Down:"Up",Left:"Right",Right:"Left"};
        if(nextDirection!==opposites[direction]) direction=nextDirection;

        let head={...snake[0]};
        if(direction==="Right") head.x++;
        if(direction==="Left") head.x--;
        if(direction==="Up") head.y--;
        if(direction==="Down") head.y++;

        if(!invincible && (head.x<0||head.x>=columns||head.y<0||head.y>=rows||snake.some(seg=>seg.x===head.x&&seg.y===head.y))){ endGame(); requestAnimationFrame(update); return; }

        snake.unshift(head);
        if(food && head.x===food.x && head.y===food.y){ score+=scorex5?5:1; scoreDiv.textContent="Score:"+score; placeFood(); } 
        else if(powerup && head.x===powerup.x && head.y===powerup.y){ activatePowerup(powerup.type); placeFood(); }
        else { snake.pop(); }

        draw(); requestAnimationFrame(update);
      }

      // input, settings, achievements (unchanged)...

      function init(){ resize(); resetGame(); requestAnimationFrame(update); }
      window.addEventListener("resize",()=>{ resize(); draw(); });
      init();
    })();
  </script>
</body>
</html>
