<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snake Game with Powerups</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
    }
    #score, #highscore {
      position: fixed;
      left: 10px;
      font-size: 20px;
      user-select: none;
      z-index: 10;
    }
    #score { top: 10px; }
    #highscore { top: 40px; }
    #powerups {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 18px;
      text-align: right;
      z-index: 10;
      user-select: none;
    }
    .pu {
      margin-bottom: 6px;
    }
    #game-over {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      font-size: 32px;
      color: red;
      text-align: center;
      display: none;
      z-index: 100;
      cursor: pointer;
    }
    #settings-btn {
      position: fixed;
      top: 80px;
      right: 10px;
      font-size: 20px;
      padding: 8px 16px;
      background: #222;
      color: #eee;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      z-index: 10;
    }
    #settings-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 20px;
      border-radius: 12px;
      display: none;
      z-index: 200;
      min-width: 240px;
    }
    .setting-group { margin-bottom: 12px; }
    .setting-group button {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    canvas { display: block; }
  </style>
</head>
<body>
  <div id="score">Score: 0</div>
  <div id="highscore">Highscore: 0</div>
  <div id="powerups"></div>
  <div id="game-over">Game Over!<br>Tap or press R to restart</div>
  <button id="settings-btn">‚öôÔ∏è</button>
  <div id="settings-modal">
    <div class="setting-group">
      <label>Difficulty</label>
      <button data-speed="150" class="difficulty-btn">Easy</button>
      <button data-speed="100" class="difficulty-btn">Medium</button>
      <button data-speed="70" class="difficulty-btn">Hard</button>
    </div>
    <div class="setting-group">
      <button id="close-settings">Close</button>
    </div>
  </div>
  <canvas id="game"></canvas>

  <script>
    (() => {
      const CELL_SIZE = 20;
      let canvas = document.getElementById("game");
      let ctx = canvas.getContext("2d");
      let width, height, columns, rows;
      let snake = [];
      let direction = "Right";
      let nextDirection = "Right";
      let score = 0;
      let gameOver = false;
      let updateDelay = 100;
      let lastUpdateTime = 0;
      let paused = false;

      const scoreDiv = document.getElementById("score");
      const highscoreDiv = document.getElementById("highscore");
      const gameOverDiv = document.getElementById("game-over");
      const settingsBtn = document.getElementById("settings-btn");
      const settingsModal = document.getElementById("settings-modal");
      const closeSettingsBtn = document.getElementById("close-settings");
      const difficultyButtons = document.querySelectorAll(".difficulty-btn");
      const powerupsDiv = document.getElementById("powerups");

      // Account + highscore
      let account = { highscore: 0 };
      function loadAccount() {
        let data = localStorage.getItem("snakeAccount");
        if (data) account = JSON.parse(data);
        highscoreDiv.textContent = "Highscore: " + account.highscore;
      }
      function saveAccount() {
        localStorage.setItem("snakeAccount", JSON.stringify(account));
        highscoreDiv.textContent = "Highscore: " + account.highscore;
      }

      // Food + powerups
      let items = []; // {x,y,type}
      function placeItem() {
        while (true) {
          let x = Math.floor(Math.random() * columns);
          let y = Math.floor(Math.random() * rows);
          if (!snake.some(seg => seg.x === x && seg.y === y)) {
            let r = Math.random();
            if (r < 0.01) items.push({x,y,type:"x5"});       // 1% Score x5
            else if (r < 0.03) items.push({x,y,type:"inv"}); // 2% Invincible
            else if (r < 0.08) items.push({x,y,type:"slow"});// 5% Slow
            else items.push({x,y,type:"food"});              // Normal
            break;
          }
        }
      }

      // Powerup states (ms timers)
      let effects = {
        slow: 0,
        inv: 0,
        x5: 0
      };

      function resetGame() {
        score = 0;
        direction = "Right";
        nextDirection = "Right";
        gameOver = false;
        items = [];
        effects = {slow:0, inv:0, x5:0};
        const startX = Math.floor(columns/2);
        const startY = Math.floor(rows/2);
        snake = [
          {x:startX,y:startY},
          {x:startX-1,y:startY},
          {x:startX-2,y:startY}
        ];
        placeItem();
        scoreDiv.textContent = "Score: " + score;
        gameOverDiv.style.display = "none";
        updatePowerupsUI();
      }

      function drawCell(x,y,color) {
        ctx.fillStyle = color;
        ctx.fillRect(x*CELL_SIZE,y*CELL_SIZE,CELL_SIZE,CELL_SIZE);
      }

      function draw() {
        ctx.clearRect(0,0,width,height);
        items.forEach(item => {
          let c = "red";
          if (item.type==="slow") c="blue";
          if (item.type==="inv") c="yellow";
          if (item.type==="x5") c="purple";
          drawCell(item.x,item.y,c);
        });
        snake.forEach((seg,i) => {
          drawCell(seg.x,seg.y,i===0?"lime":"green");
        });
      }

      function endGame() {
        if (effects.inv>0) return; // invincible active
        gameOver = true;
        gameOverDiv.style.display="block";
        if (score>account.highscore) {
          account.highscore=score;
          saveAccount();
        }
      }

      function update(timestamp) {
        if (!lastUpdateTime) lastUpdateTime=timestamp;
        let currentDelay = updateDelay;
        if (effects.slow>0) currentDelay*=2;
        if (timestamp-lastUpdateTime<currentDelay) {
          requestAnimationFrame(update); return;
        }
        lastUpdateTime=timestamp;
        if (gameOver||paused) { requestAnimationFrame(update); return; }

        // update timers
        for (let k in effects) if (effects[k]>0) {
          effects[k]-=timestamp-lastUpdateTime;
          if (effects[k]<0) effects[k]=0;
        }
        updatePowerupsUI();

        const opposites={Up:"Down",Down:"Up",Left:"Right",Right:"Left"};
        if (nextDirection!==opposites[direction]) direction=nextDirection;

        let head={...snake[0]};
        if (direction==="Right") head.x++;
        if (direction==="Left") head.x--;
        if (direction==="Up") head.y--;
        if (direction==="Down") head.y++;

        // collision
        if (
          head.x<0||head.x>=columns||head.y<0||head.y>=rows||
          snake.some(seg=>seg.x===head.x&&seg.y===head.y)
        ) {
          endGame();
          requestAnimationFrame(update); return;
        }

        snake.unshift(head);
        let ate=false;
        for (let i=0;i<items.length;i++) {
          let it=items[i];
          if (it.x===head.x&&it.y===head.y) {
            ate=true;
            if (it.type==="food") {
              score+=effects.x5>0?5:1;
            }
            if (it.type==="slow") {
              effects.slow=5000;
              score+=effects.x5>0?5:1;
            }
            if (it.type==="inv") {
              effects.inv=10000;
              score+=effects.x5>0?5:1;
            }
            if (it.type==="x5") {
              effects.x5=10000;
              score+=5;
            }
            items.splice(i,1);
            placeItem();
            break;
          }
        }
        if (!ate) snake.pop();
        scoreDiv.textContent="Score: "+score;
        draw();
        requestAnimationFrame(update);
      }

      function updatePowerupsUI() {
        powerupsDiv.innerHTML="";
        if (effects.slow>0) {
          let sec=Math.ceil(effects.slow/1000);
          powerupsDiv.innerHTML+=`<div class="pu" style="color:blue">üêå Slow: ${sec}s</div>`;
        }
        if (effects.inv>0) {
          let sec=Math.ceil(effects.inv/1000);
          powerupsDiv.innerHTML+=`<div class="pu" style="color:yellow">üõ°Ô∏è Inv: ${sec}s</div>`;
        }
        if (effects.x5>0) {
          let sec=Math.ceil(effects.x5/1000);
          powerupsDiv.innerHTML+=`<div class="pu" style="color:violet">‚úñÔ∏è5 Score: ${sec}s</div>`;
        }
      }

      function resize() {
        width=window.innerWidth;
        height=window.innerHeight;
        canvas.width=width;
        canvas.height=height;
        columns=Math.floor(width/CELL_SIZE);
        rows=Math.floor(height/CELL_SIZE);
      }

      // controls
      window.addEventListener("keydown",e=>{
        if (gameOver&&(e.key==="r"||e.key==="R")) { resetGame(); return; }
        const map={ArrowUp:"Up",ArrowDown:"Down",ArrowLeft:"Left",ArrowRight:"Right",
                   w:"Up",s:"Down",a:"Left",d:"Right"};
        let dir=map[e.key];
        if (!dir) return;
        const opposites={Up:"Down",Down:"Up",Left:"Right",Right:"Left"};
        if (dir!==opposites[direction]) nextDirection=dir;
      });

      gameOverDiv.addEventListener("click",()=>{ if(gameOver) resetGame(); });

      settingsBtn.addEventListener("click",()=>{
        paused=!paused;
        settingsModal.style.display=paused?"block":"none";
      });
      closeSettingsBtn.addEventListener("click",()=>{
        paused=false;
        settingsModal.style.display="none";
      });
      difficultyButtons.forEach(btn=>{
        btn.addEventListener("click",()=>{
          updateDelay=parseInt(btn.dataset.speed,10);
          paused=false;
          settingsModal.style.display="none";
        });
      });

      function init() {
        resize();
        loadAccount();
        resetGame();
        requestAnimationFrame(update);
      }
      window.addEventListener("resize",()=>{ resize(); draw(); });
      init();
    })();
  </script>
</body>
</html>
