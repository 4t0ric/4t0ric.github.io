<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Snake Game with Power-Ups</title>
  <style>
    body{margin:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#111;color:#fff;font-family:sans-serif}
    canvas{background:#000;touch-action:none}
    .modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#222;padding:20px;border-radius:10px;display:none;z-index:10;max-width:90%;max-height:80%;overflow:auto}
    .modal.show{display:block}
    .modal h2{margin-top:0}
    .buttons{margin:10px}
    button{margin:5px;padding:10px 15px;border:none;border-radius:8px;cursor:pointer}
    #overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;z-index:5}
    #overlay.show{display:block}
    #powerupBar{width:100%;height:20px;background:#333;margin-top:10px;display:none;border-radius:5px;overflow:hidden}
    #powerupFill{height:100%;width:100%;background:#0f0;transition:width 0.1s linear}
  </style>
</head>
<body>
  <h1>Snake Game</h1>
  <canvas id="game" width="400" height="400"></canvas>
  <div id="powerupBar"><div id="powerupFill"></div></div>
  <div class="buttons">
    <button id="settingsBtn">Settings</button>
    <button id="achievementsBtn">Achievements</button>
    <button id="codeBtn">Account Code</button>
  </div>
  <div id="overlay"></div>
  <div id="settingsModal" class="modal">
    <h2>Settings</h2>
    <label>Difficulty:
      <select id="difficulty">
        <option value="100">Easy</option>
        <option value="70" selected>Normal</option>
        <option value="50">Hard</option>
      </select>
    </label><br/>
    <label>Theme:
      <select id="theme">
        <option value="classic" selected>Classic</option>
        <option value="light">Light</option>
      </select>
    </label><br/>
    <label>Grid Size:
      <select id="grid">
        <option value="20" selected>20</option>
        <option value="25">25</option>
        <option value="40">40</option>
      </select>
    </label><br/>
    <button id="closeSettings">Close</button>
  </div>
  <div id="achievementsModal" class="modal">
    <h2>Achievements</h2>
    <ul id="achievementsList"></ul>
    <button id="closeAchievements">Close</button>
  </div>
  <script>
  (()=>{

    const canvas=document.getElementById("game");
    const ctx=canvas.getContext("2d");
    let gridSize=20;
    let snake,dir,food,score,highscore,interval;
    let paused=false;
    let account={highscore:0,achievements:{}};

    const overlay=document.getElementById("overlay");
    const settingsModal=document.getElementById("settingsModal");
    const achievementsModal=document.getElementById("achievementsModal");
    const settingsBtn=document.getElementById("settingsBtn");
    const achievementsBtn=document.getElementById("achievementsBtn");
    const closeSettings=document.getElementById("closeSettings");
    const closeAchievements=document.getElementById("closeAchievements");
    const codeBtn=document.getElementById("codeBtn");
    const difficultySelect=document.getElementById("difficulty");
    const themeSelect=document.getElementById("theme");
    const gridSelect=document.getElementById("grid");

    const powerupBar=document.getElementById("powerupBar");
    const powerupFill=document.getElementById("powerupFill");

    let moveDelay=70;
    let theme="classic";

    const achievements={
      41:"Score 41",
      50:"Score 50",
      67:"Score 67",
      69:"Score 69",
      100:"Score 100",
      200:"Score 200",
      300:"Score 300",
      400:"Score 400",
      500:"Score 500"
    };

    let activePower=null;
    let powerEnd=0;
    let multiplier=1;
    let invincible=false;
    let currentDelay=70;

    function resize(){
      let size=Math.min(window.innerWidth,window.innerHeight)-100;
      canvas.width=canvas.height=size;
    }

    function resetGame(){
      snake=[{x:10,y:10}];
      dir={x:0,y:0};
      score=0;
      spawnFood();
      activePower=null;
      powerupBar.style.display="none";
    }

    function spawnFood(){
      let type="normal";
      let r=Math.random();
      if(r<0.01){type="x5";}
      else if(r<0.03){type="inv";}
      else if(r<0.08){type="slow";}
      food={x:Math.floor(Math.random()*canvas.width/gridSize),
            y:Math.floor(Math.random()*canvas.height/gridSize),
            type:type};
    }

    function update(timestamp){
      if(paused){requestAnimationFrame(update);return;}
      if(!interval||timestamp-interval>=currentDelay){
        interval=timestamp;
        let head={x:snake[0].x+dir.x,y:snake[0].y+dir.y};
        snake.unshift(head);
        if(head.x===food.x&&head.y===food.y){
          if(food.type==="normal"){
            score+=1*multiplier;
          }else if(food.type==="slow"){
            activatePower("slow",5000);
          }else if(food.type==="inv"){
            activatePower("inv",10000);
          }else if(food.type==="x5"){
            activatePower("x5",10000);
          }
          spawnFood();
        }else{
          snake.pop();
        }
        if(!invincible){
          for(let i=1;i<snake.length;i++){
            if(head.x===snake[i].x&&head.y===snake[i].y){
              resetGame();
              break;
            }
          }
        }
        if(head.x<0||head.y<0||head.x>=canvas.width/gridSize||head.y>=canvas.height/gridSize){
          if(!invincible) resetGame();
        }
        if(score>account.highscore){account.highscore=score;saveAccount();}
        checkAchievements();
      }
      if(activePower){
        let left=powerEnd-performance.now();
        if(left<=0){
          deactivatePower();
        }else{
          powerupFill.style.width=`${(left/(powerEnd-(powerEnd-activePower.duration)))*100}%`;
        }
      }
      draw();
      requestAnimationFrame(update);
    }

    function activatePower(type,duration){
      activePower={type,duration};
      powerEnd=performance.now()+duration;
      powerupBar.style.display="block";
      if(type==="slow"){currentDelay=moveDelay*2;}
      if(type==="inv"){invincible=true;}
      if(type==="x5"){multiplier=5;}
    }

    function deactivatePower(){
      if(!activePower)return;
      if(activePower.type==="slow") currentDelay=moveDelay;
      if(activePower.type==="inv") invincible=false;
      if(activePower.type==="x5") multiplier=1;
      activePower=null;
      powerupBar.style.display="none";
    }

    function draw(){
      ctx.fillStyle=theme==="classic"?"black":"white";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle=theme==="classic"?"lime":"green";
      snake.forEach(s=>ctx.fillRect(s.x*gridSize,s.y*gridSize,gridSize,gridSize));
      if(food.type==="normal") ctx.fillStyle="red";
      if(food.type==="slow") ctx.fillStyle="blue";
      if(food.type==="inv") ctx.fillStyle="yellow";
      if(food.type==="x5") ctx.fillStyle="purple";
      ctx.fillRect(food.x*gridSize,food.y*gridSize,gridSize,gridSize);
      ctx.fillStyle=theme==="classic"?"white":"black";
      ctx.fillText("Score: "+score,10,10);
      ctx.fillText("Highscore: "+account.highscore,10,25);
    }

    document.addEventListener("keydown",e=>{
      if(e.key==="ArrowUp"&&dir.y!==1) dir={x:0,y:-1};
      if(e.key==="ArrowDown"&&dir.y!==-1) dir={x:0,y:1};
      if(e.key==="ArrowLeft"&&dir.x!==1) dir={x:-1,y:0};
      if(e.key==="ArrowRight"&&dir.x!==-1) dir={x:1,y:0};
    });

    // Swipe controls
    let touchStartX=0,touchStartY=0;
    canvas.addEventListener("touchstart",e=>{
      let t=e.touches[0];touchStartX=t.clientX;touchStartY=t.clientY;
    });
    canvas.addEventListener("touchend",e=>{
      let dx=e.changedTouches[0].clientX-touchStartX;
      let dy=e.changedTouches[0].clientY-touchStartY;
      if(Math.abs(dx)>Math.abs(dy)){
        if(dx>0&&dir.x!==-1) dir={x:1,y:0};
        if(dx<0&&dir.x!==1) dir={x:-1,y:0};
      }else{
        if(dy>0&&dir.y!==-1) dir={x:0,y:1};
        if(dy<0&&dir.y!==1) dir={x:0,y:-1};
      }
    });

    function showModal(modal){overlay.classList.add("show");modal.classList.add("show");paused=true;}
    function hideModal(modal){overlay.classList.remove("show");modal.classList.remove("show");paused=false;}

    settingsBtn.onclick=()=>showModal(settingsModal);
    achievementsBtn.onclick=()=>{renderAchievementsModal();showModal(achievementsModal);}
    closeSettings.onclick=()=>hideModal(settingsModal);
    closeAchievements.onclick=()=>hideModal(achievementsModal);

    difficultySelect.onchange=()=>{moveDelay=+difficultySelect.value;currentDelay=moveDelay;}
    themeSelect.onchange=()=>{theme=themeSelect.value;}
    gridSelect.onchange=()=>{gridSize=+gridSelect.value;resetGame();}

    function checkAchievements(){
      for(let key in achievements){
        if(score>=+key&&!account.achievements[key]){
          account.achievements[key]=true;
          saveAccount();
          alert("Achievement unlocked: "+achievements[key]);
        }
      }
    }

    function renderAchievementsModal(){
      const list=document.getElementById("achievementsList");
      list.innerHTML="";
      for(let key in achievements){
        let li=document.createElement("li");
        li.textContent=achievements[key]+(account.achievements[key]?" ✅":" ❌");
        list.appendChild(li);
      }
    }

    function saveAccount(){
      localStorage.setItem("snakeAccount",JSON.stringify(account));
    }
    function loadAccount(){
      let data=localStorage.getItem("snakeAccount");
      if(data) account=JSON.parse(data);
    }
    function encodeAccount(){
      return btoa(JSON.stringify(account));
    }
    function decodeAccount(str){
      try{return JSON.parse(atob(str));}catch{return null;}
    }

    codeBtn.addEventListener("click",()=>{
      let code=prompt("Paste your account code or leave blank to export:");
      if(code){
        let acc=decodeAccount(code);
        if(acc&&typeof acc.highscore==="number"){
          account=acc;
          if(!account.achievements) account.achievements={};
          saveAccount();
          renderAchievementsModal();
          alert("Account loaded!");
        }else alert("Invalid code!");
      }else{
        alert("Your account code: "+encodeAccount());
      }
    });

    function init(){
      resize();
      resetGame();
      loadAccount();
      renderAchievementsModal();
      requestAnimationFrame(update);
    }
    window.addEventListener("resize",()=>{resize();draw();});
    init();
  })();
  </script>
</body>
</html>
